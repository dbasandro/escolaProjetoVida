<!-- Page Content (header) -->
<section class="content-header">
    <div class="container-fluid">
       <div class="row sm-2">
          <!-- Título -->
          <div class="col-sm-6">
             <h1>Pedidos finalizados</h1>
          </div>
          <!-- Navegação histórica -->
          <div class="col-sm-6">
             <ol class="breadcrumb float-sm-right">
                <li class="breadcrumb-item"><a href="admin">Home</a></li>
                <li class="breadcrumb-item active">Cadastros</li>
                <li class="breadcrumb-item active">Requisição</li>
             </ol>
          </div>
       </div>
    </div>
 </section>
 <!-- Page Content (conteúdo) -->
 <section class="content">
    <div class="container-fluid">
       <div class="row">
          <div class="col-sm-12">
             <!-- Para iniciar fechado, adicione collapsed-card na class-->
             <div class="card card-primary card-outline">
                <!-- ######################################################################### Cabeçalho -->
                <div class="card-header">
                  <style>
                     * {
                       box-sizing: border-box;
                     }
                     body {
                       background-color: #ffffff;
                       background-attachment: fixed;
                       background-size: cover;
                     
                       font-family: "Hepta Slab", Helvetica, Arial;
                       font-size: 15px;
                       display: block;
                       margin: 0;
                       min-height: 100vh;
                     }
                     
                     
                     .menu-closer {
                       width: 32px;
                       height: 32px;
                       display: none;
                       font-size: 30px;
                       cursor: pointer;
                     }
                     
                     .cart--area {
                       padding: 20px;
                     }
                     
                     
                     .cart--item {
                       display: flex;
                       align-items: center;
                       margin: 10px 0;
                     }
                     
                     .cart--item-nome {
                       flex: 1;
                     }
                     .cart--item--qtarea {
                       display: inline-flex;
                       background-color: #eee;
                       border-radius: 10px;
                       height: 30px;
                     }
                     .cart--item--qtarea div {
                       border: 0;
                       background-color: transparent;
                       font-size: 17px;
                       outline: 0;
                       cursor: pointer;
                       padding: 0px 10px;
                       color: #333;
                     }
                     .cart--item--qt {
                       line-height: 30px;
                       font-size: 12px;
                       font-weight: bold;
                       padding: 0px 5px;
                       color: #000;
                     }
                     .cart-value {
                       padding: 15px 0;
                       border-top: 1px solid #79b9dd;
                       color: #315970;
                       display: flex;
                       justify-content: space-between;
                       font-size: 15px;
                     }
                     .cart-value span:first-child {
                       font-weight: bold;
                     }
                     .cart-value.big {
                       font-size: 20px;
                       color: #000;
                       font-weight: bold;
                     }
                     .cart--finalizar {
                       padding: 20px 30px;
                       border-radius: 20px;
                       background-color: #48d05f;
                       color: #fff;
                       cursor: pointer;
                       text-align: center;
                       margin-top: 20px;
                       border: 2px solid #63f77c;
                       transition: all ease 0.2s;
                     }
                     .cart--finalizar:hover {
                       background-color: #35af4a;
                     }
                     
                     @media (max-width: 1000px) {
                       .pizza-area {
                         grid-template-columns: repeat(2, 1fr);
                       }
                     }
                     
                     @media (max-width: 25px) {
                       body {
                         flex-direction: column;
                       }
                     
                       header {
                         display: flex;
                       }
                       main {
                         padding-top: 60px;
                       }
                     
                       aside {
                         width: auto;
                         position: fixed;
                         left: 100vw;
                         right: 0;
                         top: 0;
                         bottom: 0;
                         transition: all ease 0.2s;
                       }
                       aside.show {
                         width: auto;
                       }
                       .cart--area {
                         width: 100vw;
                       }
                     }

                     </style>
                         <!-- Conteúdo central do modal -->
                         <form role="form" action="/addEntrega" method="post" enctype="multipart/form-data">
                           <!-- Campos do formulário -->
                           <!-- Campos do formulário -->
                           <div class="modal-body">
                              <!-- Cod -->
                              <div class="row" style="display: none;">
                                 <div class="col-sm-12">
                                    <div class="form-group">
                                       <label for="cod_ADD" class="label">Cod</label>
                                       <input type="text" autocomplete="off" class="form-control form-control-sm"
                                          name="cod_ADD" id="cod_ADD" placeholder="Cod" readonly=“true” value="">
                                    </div>
                                 </div>
                              </div>
                              <div class="col-sm-12">
                                 <!-- Campos de cadastro -->
                                 <div class="row">
                                    <div class="col-sm-12">
                                       <div class="row">


                                
                                          <!-- Setor -->
                                          <div class="col-sm-4">
                                             <div class="form-group">
                                                <label for="id_departamento_ADD" id ="id_departamento_ADD" class="label"></label>

                                             </div>
                                          </div>
                                          <!-- Turma -->
                                          <div class="col-sm-4">
                                             <div class="form-group">
                                                <label for="id_turma_ADD" id ="id_turma_ADD" class="label"></label>

                                             </div>
                                          </div>
                                          <!-- Disciplina -->
                                          <div class="col-sm-4">
                                             <div class="form-group">
                                                <label for="id_disciplina_ADD" id ="id_disciplina_ADD" class="label"></label>

                                             </div>
                                          </div>
                                          <!-- Observação -->
                                          <div class="col-sm-12">
                                             <div class="form-group">
                                                <label for="observacao_ADD" id ="observacao_ADD" class="label"></label>
                                             </div>
                                          </div>
                                             



                                          <!-- Botões -->

                                       </div>
                                    </div>
                                 </div>
                              </div>
                                 <!--compras-->
                                 <div class="col-sm-12"></div>
                                 <div class="cart--area" id="produto" >
                                    <div class="menu-closer"></div>
                                    <div class="cart" id="cart">
                               </div>  
                                    <div class="cart--details">
                                      <div class="cart-value total big">
                                        <span>Total geral</span>
                                        <span class="cart-value-total" id="valorTotalCompra">00,00</span>
                                      </div>
                                    </div>
                                   
                                    
                                       
                                       
                                   
                                    <!--cart--details-->
                                  </div>  
                                 </div>  
                           </div>
                      
                     </div>
                   
                  </div>
                 
                  </form>
                              

                     
                             
               
                                           
                     
                      
                     
                     <script>

                   

// Definir variáveis universais

var pedidos =[]; 



//FUNÇÃO QUE ADICIONA e EXCLUi ÍTEM SELECIONADO NO ARRAY E NA DIV (nome produto, valor produto, checkbox)
function agrupaarray() {
   let resultado = cods.map((p, i) => {
  return [p, valorTotal[i].toFixed(2), valorProduto[i], qtd[i] ,unidades[i], users[i]]
})



let observacao = document.getElementById('observacao_ADD');


let dados = (nomes.length);

console.log(observacao)

if (observacao != "") {
if (dados > 0) {
   alert('Solitação feita com sucesso !')
fetch("//addEntrega", {
            method: "POST",
            headers: {
               "Content-Type": "application/json",
            },
            body: JSON.stringify(resultado),
          })
            //.then((response) => response.json())
            .then((results) => {
              //console.log("Success:", results);
            })
            .catch((error) => {
              //console.error("Error:", error);
            });

         }
      }
}



function adicionaeexcluidiv(id_pedido, nome, quantidades, unitarios, totals, obs, dpt, tm, disc, total_pedido) {

total_geral = document.getElementById('valorTotalCompra');
total_geral.innerHTML = total_pedido

var input1 = document.getElementById('cod_ADD');

input1.value = id_pedido;

   
   let observacao = document.getElementById('observacao_ADD');
   let departamento = document.getElementById('id_departamento_ADD');
   let turma = document.getElementById('id_turma_ADD');
   let disciplina = document.getElementById('id_disciplina_ADD');


   observacao.innerHTML  = 'Observação: '+ obs;
   departamento.innerHTML  = 'Departamento: '+ dpt;
   turma.innerHTML  = 'Turma: '+ tm;
   disciplina.innerHTML  = 'Disciplina: '+ disc;


   //SELECINANDO AONDE SERÁ INSERIDO A DIV
let dependentes_container = document.querySelector(".cart");

let check = id_pedido

if (pedidos.length > 0) {
   pedidos.pop();




let alvo = document.getElementById("cart");

alvo.innerText = "";

//observacao.innerHTML  = ''
//departamento.innerHTML  = ''
//turma.innerHTML  = ''
//disciplina.innerHTML  = ''
}

//VERIFICANDO SE CHECKBOX ESTÁ ATIVO OU INATIVO
   let checkbox = document.getElementById(check);
if(checkbox.checked) {

  
   
// ATIVO = VERIFICAR SE O NOME JA EXISTE NO ARRAY
result = pedidos.includes(id_pedido);
if  (result === false) {
pedidos.push(id_pedido);

}
else {}

teste = nome.split(",")
quantidade = quantidades.split(",")
unitario = unitarios.split(",")
total = totals.split(",")

comando = id_pedido +'1'

let i = 0;






while(i <= teste.length+1){
    
    
   array = teste.slice(0, 1);
   QuantidadeArray = quantidade.slice(0, 1);
   UnitarioArray = unitario.slice(0, 1);
   TotalArray = total.slice(0, 1);
    

   if (TotalArray.length === 0) {

   } else {

    let dependente_container = `<div class="cart--item" id="`+comando+`">
                       <div class="cart--item-nome">`+array+`</div>
                       <div class="cart--item--qtarea">
                         <div class="cart--item--qt" id="`+array+`">`+QuantidadeArray+' x '+UnitarioArray+`</div>
                       </div>
                       <td>
                        Total R$: <span id="total`+array+`">`+TotalArray+`</span></td>
                     </div>`;
    dependentes_container.innerHTML += dependente_container;
                  }

    teste.shift();
    quantidade.shift();
   unitario.shift();
total.shift();

    i++;
   };

    console.log("O cliente marcou o checkbox");


} else {

   item = pedidos.indexOf(id_pedido);

   var indice = pedidos.findIndex((item) => item == id_pedido);
  
   pedidos.splice(indice, 1);
 

   let alvo = document.getElementById("cart");

   alvo.innerText = "";

   observacao.innerHTML  = ''
   departamento.innerHTML  = ''
   turma.innerHTML  = ''
   disciplina.innerHTML  = ''


 
    console.log("O cliente não marcou o checkbox");
  

    
};


function excluir (comando) { 
    
   document.getElementById(comando).remove();
};
                  };












                    </script>
                  
                  
                  
                   <!-- Botão Ocultar ou exibir o card -->
                   <section class="content">
                     <div class="container-fluid">
                         <div class="row">
                             <div class="col-sm-12">
                 
                                 <!-- Para iniciar fechado, adicione collapsed-card na class-->
                                 <div class="card card-primary card-outline">
                 
                                     <!-- ######################################################################### Cabeçalho -->
                                     <div class="card-header">
                 

 
                 
                                         <!-- Botão Ocultar ou exibir o card -->
                                         <div class="card-tools">
                                             <!-- Botão Abrir/fechar card (Icone: fa-minus ou fa-plus) -->
                                             <button type="button" class="btn btn-tool" data-card-widget="collapse" data-toggle="tooltip"
                                                 title="Collapse">
                                                 <i class="fas fa-minus"></i>
                                             </button>
                                             <!-- Botão destruir card -->
                                             <button type="button" class="btn btn-tool" data-card-widget="remove" data-toggle="tooltip"
                                                 title="Remove">
                                                 <i class="fas fa-times"></i>
                                             </button>
                                         </div>
                 
                                     </div>
                <!-- ######################################################################### Tabela -->
                <div class="card-body">

                  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		
                  <script>
                     

                     $(document).ready(function() {
                        $.fn.dataTable.ext.errMode = 'none';
    $('#TBtable').DataTable( {
        "order": [[ 0, "desc" ]],
        "bDestroy": true

        
   
} );
                     });
                     
                     
                  </script>

                  <% if (DTMaterial.length > 0) {%>
                      
                  <table id="TBtable" class="table-bordered">

                      <!-- Cabeçalho: Titulos da tabela -->
                      <thead class="thead-light">
                          <tr>
                           <th scope="col">Cod</th>
                           <th scope="col">Solicitante</th>
                           <th scope="col">Turma</th>
                           <th scope="col">Departamento</th>
                           <th scope="col">Centro de Custo</th>
                           <th scope="col">DateTime</th>
                              
                          </tr>
                      </thead>


                      <tbody>
                          <!-- Detalhes: Dados da tabela -->
                          <% DTMaterial.forEach((row, index) => { %>
                           
                          <tr>
                              <td><%= row.id_pedido %> <input type="radio" id="<%= row.id_pedido %>" name="scales" class="<%= row.id_pedido %>" onclick="adicionaeexcluidiv('<%= row.id_pedido %>','<%= row.produtos %>','<%= row.quantidade %>','<%= row.unitario %>','<%= row.total %>', '<%= row.observacao %>' , '<%= row.departamento %>', '<%= row.turma %>', '<%= row.disciplina %>', '<%= row.total_pedido %>')"></td>
                              <td><%= row.solicitante %> </td>
                              <td><%= row.turma %></td>
                              <td><%= row.departamento %></td>
                              <td><%= row.centrodecusto %></td>
                              <td><%= row.data %></td>

                          </tr>
                          <% }) %>
                      </tbody>

                      <!-- Pesquisa -->
                      <tfoot>
                          <tr>
                           <th scope="col">Cod</th>
                           <th scope="col">Solicitante</th>
                           <th scope="col">Turma</th>
                           <th scope="col">Departamento</th>
                           <th scope="col">Centro de Custo</th>
                           <th scope="col">DateTime</th>
                              
                          </tr>
                      </tfoot>

                  </table>
                   <% } else { %>
                   <!-- Não existe dados na tabela -->
                   <p class="text-center">Clique <a data-toggle="modal" data-target="#modalADD"
                      style="cursor:pointer; color:rgb(79, 79, 255)"> aqui </a> para adicionar um novo
                      registro.
                   </p>
                   <% } %>
                </div>             
          </div>   
    </div>
    </div>
    </div>

    </div>
 
 <!-- Grava o texto recebido da variável status_Crud do routes/usuario
    lá no "tails.ejs" tem uma função no final que verifica o que tem neste span"
    e dispara uma função de alerta do toastr de acordo com o texto -->
 <span style="display:none" id='status_Crud'><%= status_Crud %></span>